 <%= render '/trade123/traderun_menu' %>
 
 <% @trade_session_id =  @current_task.state.split("-").last %>
 <%# @commodities_for_sell = MilkRun.joins(:buy_commodity).pluck('commodities.name', 'commodities.id') %>
 <% @session_milkruns = MilkRun.where(trade_session_id: @trade_session_id) %>

 <% @commodities_for_sell = @session_milkruns.where(sell_commodity_id: nil).joins(:buy_commodity).pluck('commodities.id') %>
 <% @milk_runs_buy =  @session_milkruns.where("sell_commodity_price IS NULL OR sell_commodity_price = 0") %>
 <% @milk_runs_sell =  @session_milkruns.where("sell_commodity_price > 0") %>
 


<%# @locations_for_sell = Location.where(name: @commodities_for_sell.map(&:location)).distinct %>
<% end_column = "I" %>
 <div data-controller="milkrun">
 <table id="spreadsheetTable">
   <thead>
     <tr>
       <th></th>
       <% ('A'..end_column).each do |char| %>
         <th><%= char %></th>
       <% end %>
     </tr>
   </thead>
   <tbody>
     
<%= render '/trade123/milk_run_buy_form', end_column: end_column %>
<%= render '/trade123/milk_run_sell_form', end_column: end_column %>
     


<tr class="white">
  <td></td>
  <td>4</td>
  <td>Inventory</td>
  <td>Buy Scu</td>
  <td>Buy Price</td>
  <td></td>
  <td></td>
  <td></td>
  <td></td>
  <td></td>
</tr>

<% @milk_runs_buy.each_with_index do |milk_run, index| %>
  <tr>
    <td><%= index + 3 %></td>
    <% ('A'..end_column).each do |char| %>
      <% if char == 'A' %>
        <td>BUY</td>
        <% elsif char == 'B' %>
        <td><%= milk_run.buy_commodity&.name %></td>
        <% elsif char == 'C' %>
        <td><%= milk_run.buy_commodity_scu %>SCU</td>
        <% elsif char == 'D' %>
        <td><%= milk_run.buy_commodity_price %>aUEC</td>
         <% else %>
        <td></td>
         <% end %>
    <% end %>
    </tr>
  <% end %>


  <tr class="white">
  <td></td>
  <td>8</td>
  <td>Sold</td>
  <td>Buy Scu</td>
  <td>Buy Price</td>
  <td>Sell Scu</td>
  <td>Sell Price</td>
  <td></td>
  <td></td>
  <td></td>
</tr>

  <% @milk_runs_sell.each_with_index do |milk_run, index| %>
    <tr>
      <td><%= index + 6 %></td>
      <% ('A'..end_column).each do |char| %>
        <% if char == 'A' %>
          <td>BUY</td>
          <% elsif char == 'B' %>
          <td><%= milk_run.buy_commodity&.name %></td>
          <% elsif char == 'C' %>
          <td><%= milk_run.buy_commodity_scu %>SCU</td>
          <% elsif char == 'D' %>
          <td><%= milk_run.buy_commodity_price %>aUEC</td>
          <% elsif char == 'E' %>
          <td><%= milk_run.sell_commodity_scu %>SCU</td>
          <% elsif char == 'F' %>
          <td><%= milk_run.sell_commodity_price %>aUEC</td>
          <% elsif char == 'g' %>
          <td><%= milk_run.profit %>aUEC</td>
           <% else %>
          <td></td>
           <% end %>
      <% end %>
      </tr>
    <% end %>

     
   </tbody>
 </table>
</div>

<div id="data" >
  <%= content_tag :div, id: "locations-data", class: "hidden", data: { locations: @all_locations_parent_grouped.to_json(only: [:name, :parent]) } do %><% end %>
  <%= content_tag :div, id: "ships-data", class: "hidden", data: { ships: @cargo_ships.to_json(only: [:model, :scu]) } do %><% end %>
  <%= content_tag :div, id: "commodities-data", class: "hidden", data: { milkrun_target:'commoditiesData', commodities: @all_commodities.to_json(only: [:id, :name, :buy, :sell, :location, :updated_at]) } do %><% end %>
  <%= content_tag :div, id: "milkruns-data", class: "hidden", data: { milkrun_target:'milkRunData', milk_runs: MilkRun.select_by_session(@trade_session_id).to_json(only: [:id, :buy_commodity_id, :buy_commodity_price, :buy_commodity_scu, :commodity_name, :buy_location, :updated_at]) } do %><% end %>
</div>


<style>
  #spreadsheetTable {
    width: 100%;
    text-align: center;
    border-collapse: collapse;
  }

  #spreadsheetTable th, #spreadsheetTable td {
    border: 1px solid #ddd;
    padding: 8px;
  }

  #spreadsheetTable th {
    background-color: #f2f2f2;
  }

#shell .shell-container #traderun input{
color: #b9b9b9;
}

</style>

